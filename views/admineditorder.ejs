<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Edit Order Status | FluffyFriend</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #fff6fb;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    main {
      flex: 1;
      padding-bottom: 2rem;
    }
 .navbar {
      background: linear-gradient(90deg,#ff8db8,#ff6fa3);
    }
    .navbar-brand {
      color:#fff; font-weight:700;
    }
    .nav-link {
      color:#fff !important;
      font-weight:500;
      border-radius:8px;
      padding:8px 14px;
      transition:.3s;
    }
    .nav-link:hover {
      background:#ff8db8;
      color:#fff !important;
    }
    .card-shell {
      background: #fff;
      border-radius: 24px;
      padding: 2rem;
      box-shadow: 0 25px 60px rgba(255,111,163,0.2);
    }
    .summary-pill {
      background: #ffe3f0;
      border-radius: 12px;
      padding: 1rem;
    }
    .summary-pill span {
      display: block;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #a66384;
    }
    .summary-pill strong {
      font-size: 1.35rem;
      color: #ff6fa3;
    }
    .btn-pink {
      background: #ff6fa3;
      color: #fff;
      border: none;
    }
    .btn-pink:hover {
      background: #ff8db8;
      color: #fff;
    }
    .hero-intro {
      background: linear-gradient(135deg, #f2f7ff 0%, #fff5ea 55%, #f3f8ff 100%);
      border-radius: 22px;
      padding: 1.5rem 2rem;
      border: 1px solid rgba(255, 181, 90, .2);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      flex-wrap: wrap;
      position: relative;
      overflow: hidden;
    }
    .hero-intro::after {
      content: "";
      position: absolute;
      width: 180px;
      height: 180px;
      background: radial-gradient(circle at top right, rgba(255, 168, 102, .35), transparent 70%);
      top: -80px;
      right: -60px;
      border-radius: 50%;
    }
    .hero-left {
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
    }
    .hero-icon {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #f59e0b, #fbbf24);
      color: #fff;
      font-size: 1rem;
      font-weight: 700;
      letter-spacing: 0.08em;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 12px 25px rgba(245, 158, 11, .35);
    }
    .hero-text h2 { margin-bottom: .4rem; font-weight: 700; color: #101828; }
    .hero-text p { margin: 0; color: #475467; }
    .hero-badge {
      background: rgba(245, 158, 11, .15);
      color: #b45309;
      padding: .25rem .85rem;
      border-radius: 999px;
      font-size: .8rem;
      text-transform: uppercase;
      letter-spacing: .08em;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <%- include('partials/admin_navbar') %>

  <main class="container my-4">
    <div class="hero-intro">
      <div class="hero-left">
        <div class="hero-icon" aria-hidden="true">OS</div>
        <div class="hero-text">
          <h2 class="mb-1">Edit Order Status</h2>
          <p>Update fulfillment for this order.</p>
        </div>
        <span class="hero-badge">Orders</span>
      </div>
      <a href="/admin/orders" class="btn btn-outline-secondary">Back to Orders</a>
    </div>

    <% if (success && success.length) { %>
      <div class="alert alert-success"><%= success[0] %></div>
    <% } %>
    <% if (error && error.length) { %>
      <div class="alert alert-danger"><%= error[0] %></div>
    <% } %>

    <div class="card-shell">
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="summary-pill">
            <span>Invoice</span>
            <strong><%= order.invoice_number %></strong>
          </div>
        </div>
        <div class="col-md-4">
          <div class="summary-pill">
            <span>Total Amount</span>
            <strong>$<%= Number(order.total || 0).toFixed(2) %></strong>
          </div>
        </div>
        <div class="col-md-4">
          <div class="summary-pill">
            <span>Current Status</span>
            <strong><%= order.status || 'On Hold' %></strong>
          </div>
        </div>
      </div>

      <%
        const autoTrackingNumber = (order.invoice_number || '').replace(/\D/g, '') || String(Date.now());
        const todayIso = new Date().toISOString().slice(0, 10);
        const shipmentIso = order.shipment_date
          ? new Date(order.shipment_date).toISOString().slice(0, 10)
          : todayIso;
        const carrierValue = order.carrier || 'DHL';
        const rawPayment = String(order.payment_method || order.paymentMethod || '').toLowerCase();
        const isPaypalOrder = rawPayment === 'paypal' || !!order.paypal_capture_id;
      %>
      <form action="/admin/orders/<%= order.id %>/edit" method="POST">
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="invoiceNumber" class="form-label fw-semibold">Invoice Number</label>
            <input type="text" class="form-control" id="invoiceNumber" name="invoiceNumber" value="<%= order.invoice_number %>" readonly>
          </div>
          <div class="col-md-6">
            <label for="totalAmount" class="form-label fw-semibold">Total Amount</label>
            <input type="text" class="form-control" id="totalAmount" name="totalAmount" value="$<%= Number(order.total || 0).toFixed(2) %>" readonly>
          </div>
        </div>
        <div class="mb-3">
          <label for="status" class="form-label fw-semibold">Order Status</label>
          <select id="status" name="status" class="form-select" required>
            <% statuses.forEach(function(status) { %>
              <option value="<%= status %>" <%= (order.status || 'On Hold') === status ? 'selected' : '' %>><%= status %></option>
            <% }); %>
          </select>
        </div>
        <% if (isPaypalOrder) { %>
          <h5 class="fw-semibold mt-4 mb-2">PayPal Tracking</h5>
          <div class="row g-3 mb-3">
            <div class="col-md-6">
              <label for="captureId" class="form-label fw-semibold">PayPal Capture ID</label>
              <input type="text" class="form-control" id="captureId" name="captureId" placeholder="e.g. 8VV12345ABC" value="<%= order.paypal_capture_id || '' %>" readonly>
            </div>
            <div class="col-md-6">
              <label for="trackingNumber" class="form-label fw-semibold">Tracking Number</label>
              <input type="text" class="form-control" id="trackingNumber" name="trackingNumber" placeholder="e.g. 1234567890" value="<%= autoTrackingNumber %>" readonly>
            </div>
            <div class="col-md-6">
              <label for="carrier" class="form-label fw-semibold">Carrier</label>
              <select id="carrier" name="carrier" class="form-select">
                <option value="DHL" <%= carrierValue === 'DHL' ? 'selected' : '' %>>DHL</option>
                <option value="FEDEX" <%= carrierValue === 'FEDEX' ? 'selected' : '' %>>FedEx</option>
              </select>
            </div>
            <input type="hidden" name="trackingNumberType" value="CARRIER_PROVIDED">
            <div class="col-md-6">
              <label for="shipmentDate" class="form-label fw-semibold">Shipment Date</label>
              <input type="date" class="form-control" id="shipmentDate" name="shipmentDate" value="<%= shipmentIso %>">
            </div>
            <div class="col-md-6 d-flex align-items-end">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" id="syncPaypal" name="syncPaypal" value="true" checked>
                <label class="form-check-label fw-semibold" for="syncPaypal">Sync status to PayPal</label>
              </div>
            </div>
          </div>
        <% } %>
        <button type="submit" class="btn btn-pink px-4">Save Status</button>
      </form>
    </div>
  </main>

  <%- include('partials/footer') %>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
