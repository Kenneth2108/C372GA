<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Edit Order Status | FluffyFriend</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #fff6fb;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    main {
      flex: 1;
      padding-bottom: 2rem;
    }
 .navbar {
      background: linear-gradient(90deg,#ff8db8,#ff6fa3);
    }
    .navbar-brand {
      color:#fff; font-weight:700;
    }
    .nav-link {
      color:#fff !important;
      font-weight:500;
      border-radius:8px;
      padding:8px 14px;
      transition:.3s;
    }
    .nav-link:hover {
      background:#ff8db8;
      color:#fff !important;
    }
    .card-shell {
      background: #fff;
      border-radius: 24px;
      padding: 2rem;
      box-shadow: 0 25px 60px rgba(255,111,163,0.2);
    }
    .summary-pill {
      background: #ffe3f0;
      border-radius: 12px;
      padding: 1rem;
    }
    .summary-pill span {
      display: block;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: #a66384;
    }
    .summary-pill strong {
      font-size: 1.35rem;
      color: #ff6fa3;
    }
    .btn-pink {
      background: #ff6fa3;
      color: #fff;
      border: none;
    }
    .btn-pink:hover {
      background: #ff8db8;
      color: #fff;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <%- include('partials/admin_navbar') %>

  <main class="container my-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <div>
        <h2 class="fw-bold mb-0">Edit Order Status</h2>
        <p class="text-muted mb-0">Update fulfillment for this order.</p>
      </div>
      <a href="/admin/orders" class="btn btn-outline-secondary">Back to Orders</a>
    </div>

    <% if (success && success.length) { %>
      <div class="alert alert-success"><%= success[0] %></div>
    <% } %>
    <% if (error && error.length) { %>
      <div class="alert alert-danger"><%= error[0] %></div>
    <% } %>

    <div class="card-shell">
      <div class="row g-3 mb-4">
        <div class="col-md-4">
          <div class="summary-pill">
            <span>Invoice</span>
            <strong><%= order.invoice_number %></strong>
          </div>
        </div>
        <div class="col-md-4">
          <div class="summary-pill">
            <span>Total Amount</span>
            <strong>$<%= Number(order.total || 0).toFixed(2) %></strong>
          </div>
        </div>
        <div class="col-md-4">
          <div class="summary-pill">
            <span>Current Status</span>
            <strong><%= order.status || 'On Hold' %></strong>
          </div>
        </div>
      </div>

      <%
        const autoTrackingNumber = (order.invoice_number || '').replace(/\D/g, '') || String(Date.now());
        const todayIso = new Date().toISOString().slice(0, 10);
        const shipmentIso = order.shipment_date
          ? new Date(order.shipment_date).toISOString().slice(0, 10)
          : todayIso;
        const carrierValue = order.carrier || 'DHL';
      %>
      <form action="/admin/orders/<%= order.id %>/edit" method="POST">
        <div class="mb-3">
          <label for="status" class="form-label fw-semibold">Order Status</label>
          <select id="status" name="status" class="form-select" required>
            <% statuses.forEach(function(status) { %>
              <option value="<%= status %>" <%= (order.status || 'On Hold') === status ? 'selected' : '' %>><%= status %></option>
            <% }); %>
          </select>
        </div>
        <div class="row g-3 mb-3">
          <div class="col-md-6">
            <label for="captureId" class="form-label fw-semibold">PayPal Capture ID</label>
            <input type="text" class="form-control" id="captureId" name="captureId" placeholder="e.g. 8VV12345ABC" value="<%= order.paypal_capture_id || '' %>" readonly>
          </div>
          <div class="col-md-6">
            <label for="trackingNumber" class="form-label fw-semibold">Tracking Number</label>
            <input type="text" class="form-control" id="trackingNumber" name="trackingNumber" placeholder="e.g. 1234567890" value="<%= autoTrackingNumber %>" readonly>
          </div>
          <div class="col-md-6">
            <label for="carrier" class="form-label fw-semibold">Carrier</label>
            <select id="carrier" name="carrier" class="form-select">
              <option value="DHL" <%= carrierValue === 'DHL' ? 'selected' : '' %>>DHL</option>
              <option value="FEDEX" <%= carrierValue === 'FEDEX' ? 'selected' : '' %>>FedEx</option>
              <option value="UPS" <%= carrierValue === 'UPS' ? 'selected' : '' %>>UPS</option>
              <option value="USPS" <%= carrierValue === 'USPS' ? 'selected' : '' %>>USPS</option>
              <option value="OTHER" <%= carrierValue === 'OTHER' ? 'selected' : '' %>>Other</option>
            </select>
          </div>
          <input type="hidden" name="trackingNumberType" value="CARRIER_PROVIDED">
          <div class="col-md-6">
            <label for="shipmentDate" class="form-label fw-semibold">Shipment Date</label>
            <input type="date" class="form-control" id="shipmentDate" name="shipmentDate" value="<%= shipmentIso %>">
          </div>
          <div class="col-md-6" id="carrierNameOtherGroup">
            <label for="carrierNameOther" class="form-label fw-semibold">Carrier Name (If Other)</label>
            <input type="text" class="form-control" id="carrierNameOther" name="carrierNameOther" placeholder="Custom carrier name">
          </div>
          <div class="col-md-6 d-flex align-items-end">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="syncPaypal" name="syncPaypal" value="true" checked>
              <label class="form-check-label fw-semibold" for="syncPaypal">Sync status to PayPal</label>
            </div>
          </div>
        </div>
        <button type="submit" class="btn btn-pink px-4">Save Status</button>
      </form>
    </div>
  </main>

  <%- include('partials/footer') %>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function () {
      var carrierSelect = document.getElementById('carrier');
      var carrierOtherGroup = document.getElementById('carrierNameOtherGroup');
      var carrierOtherInput = document.getElementById('carrierNameOther');
      if (!carrierSelect || !carrierOtherGroup || !carrierOtherInput) return;

      function toggleCarrierOther() {
        var show = carrierSelect.value === 'OTHER';
        carrierOtherGroup.style.display = show ? '' : 'none';
        carrierOtherInput.required = show;
        if (!show) {
          carrierOtherInput.value = '';
        }
      }

      carrierSelect.addEventListener('change', toggleCarrierOther);
      toggleCarrierOther();
    })();
  </script>
</body>
</html>
