<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Checkout Payment</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    :root {
      color-scheme: light;
    }
    body {
      background: radial-gradient(circle at top, #ffe8f3 0%, #fff6fb 45%, #ffeef6 100%);
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .ff-main {
      flex: 1 0 auto;
      padding: 40px 0 80px;
    }
    .checkout-hero {
      max-width: 680px;
      margin: 0 auto 32px;
    }
    .checkout-hero .eyebrow-label {
      letter-spacing: 0.2em;
      text-transform: uppercase;
      font-size: 0.85rem;
      color: #ff6fa3;
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: inline-block;
    }
    .checkout-hero h1 {
      font-weight: 700;
      color: #312631;
    }
    .payment-card,
    .summary-card {
      background: #fff;
      border-radius: 24px;
      padding: 28px;
      box-shadow: 0 25px 60px rgba(255, 111, 163, 0.18);
      border: 1px solid #ffe1ee;
    }
    .payment-methods {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
    }
    .method-card {
      border-radius: 18px;
      padding: 20px;
      border: 1px solid #ffd7e8;
      background: #fff7fb;
    }
    .method-card.muted {
      background: #fff;
      border-style: dashed;
      opacity: 0.8;
    }
    .method-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      margin-bottom: 0.5rem;
    }
    .method-choice {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      color: #312631;
    }
    .method-choice input {
      accent-color: #ff6fa3;
    }
    .method-header h3 {
      margin: 0;
      font-size: 1.15rem;
      font-weight: 700;
      color: #312631;
    }
    .pill {
      background: #ff6fa3;
      color: #fff;
      border-radius: 999px;
      font-size: 0.7rem;
      padding: 4px 10px;
      letter-spacing: 0.08em;
      text-transform: uppercase;
    }
    .pill.soon {
      background: #ffbf47;
      color: #472a00;
    }
    .summary-card h2,
    .payment-card h2 {
      font-weight: 700;
      color: #312631;
      margin-bottom: 1.25rem;
    }
    .summary-item {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      padding: 0.45rem 0;
      border-bottom: 1px solid #f9ddeb;
    }
    .summary-item:last-child {
      border-bottom: none;
    }
    .summary-item span {
      color: #6b5566;
      font-size: 0.95rem;
    }
    .summary-total {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px dashed #ffd7e8;
      font-size: 1.1rem;
      font-weight: 700;
      color: #ff3d72;
      display: flex;
      justify-content: space-between;
    }
    .btn-outline-pink {
      border: 1px solid #ff6fa3;
      color: #ff6fa3;
    }
    .btn-outline-pink:hover {
      background-color: #ff6fa3;
      color: #fff;
    }
    #payment-status {
      min-height: 20px;
    }
  </style>
</head>
<body>
  <%- include('partials/user_navbar') %>

  <main class="ff-main">
    <div class="container">
      <section class="checkout-hero text-center">
        <span class="eyebrow-label">Secure checkout</span>
        <h1>Choose Your Payment</h1>
        <p class="text-muted mb-0">Pick a method to complete your fluffy order.</p>
      </section>

      <div class="row g-4">
        <div class="col-lg-7">
          <div class="payment-card">
            <h2>Payment Methods</h2>
            <div class="payment-methods">
              <div class="method-card">
                <div class="method-header">
                  <div class="method-choice">
                    <input type="radio" name="paymentMethod" id="method-paypal" value="paypal" required>
                    <label for="method-paypal">PayPal</label>
                  </div>
                  <span class="pill">Recommended</span>
                </div>
                <p class="text-muted mb-3">Pay quickly with your PayPal balance or card.</p>
                <div id="paypal-button-container" style="display: none;"></div>
                <div id="payment-status" class="text-danger small" role="alert"></div>
              </div>

              <div class="method-card">
                <div class="method-header">
                  <div class="method-choice">
                    <input type="radio" name="paymentMethod" id="method-nets" value="nets" required>
                    <label for="method-nets">NETS</label>
                  </div>
                  <span class="pill">Scan to Pay</span>
                </div>
                <p class="text-muted mb-3">Youâ€™ll be shown a NETS QR code to scan and pay.</p>

                <form action="/generateNETSQR" method="POST" class="m-0" id="nets-form">
                  <input type="hidden" name="cartTotal" value="<%= summary.total.toFixed(2) %>">
                  <button type="submit" class="btn btn-outline-pink w-100" id="nets-button" disabled>Pay with NETS</button>
                </form>
              </div>

              <div class="method-card">
                <div class="method-header">
                  <div class="method-choice">
                    <input type="radio" name="paymentMethod" id="method-stripe" value="stripe" required>
                    <label for="method-stripe">Stripe</label>
                  </div>
                  <span class="pill">Card</span>
                </div>
                <p class="text-muted mb-3">Pay securely with credit/debit card via Stripe Checkout.</p>
                <button type="button" class="btn btn-outline-pink w-100" id="stripe-button" disabled>Pay with Stripe</button>
                <div id="stripe-status" class="text-danger small mt-2" role="alert"></div>
              </div>
            </div>
          </div>
        </div>

        <div class="col-lg-5">
          <div class="summary-card">
            <h2>Order Summary</h2>
            <% items.forEach(function(item) { %>
              <div class="summary-item">
                <span><%= item.productName %> x <%= item.quantity %></span>
                <strong>$<%= item.lineTotal.toFixed(2) %></strong>
              </div>
            <% }) %>
            <div class="summary-item">
              <span>Subtotal</span>
              <strong>$<%= summary.subtotal.toFixed(2) %></strong>
            </div>
            <div class="summary-item">
              <span>GST (9%)</span>
              <strong>$<%= summary.taxAmount.toFixed(2) %></strong>
            </div>
            <div class="summary-total">
              <span>Total</span>
              <span>$<%= summary.total.toFixed(2) %></span>
            </div>
            <a href="/cart" class="btn btn-outline-pink w-100 mt-4">Back to Cart</a>
          </div>
        </div>
      </div>
    </div>
  </main>

  <%- include('partials/footer') %>

  <script src="https://www.paypal.com/sdk/js?client-id=<%= paypalClientId %>&currency=SGD"></script>
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    (function() {
      var paypalClientId = '<%= paypalClientId %>';
      var stripePublishableKey = '<%= stripePublishableKey %>';
      var statusEl = document.getElementById('payment-status');
      var stripeStatusEl = document.getElementById('stripe-status');
      var paypalContainer = document.getElementById('paypal-button-container');
      var netsButton = document.getElementById('nets-button');
      var stripeButton = document.getElementById('stripe-button');
      var stripe = stripePublishableKey ? Stripe(stripePublishableKey) : null;

      function setStatus(message) {
        statusEl.textContent = message || '';
      }

      function setStripeStatus(message) {
        if (stripeStatusEl) {
          stripeStatusEl.textContent = message || '';
        }
      }

      function setSelectedMethod(method) {
        if (paypalContainer) {
          paypalContainer.style.display = method === 'paypal' ? 'block' : 'none';
        }
        if (netsButton) {
          netsButton.disabled = method !== 'nets';
        }
        if (stripeButton) {
          stripeButton.disabled = method !== 'stripe';
        }
        if (method !== 'paypal') {
          setStatus('');
        }
        if (method !== 'stripe') {
          setStripeStatus('');
        }
      }

      document.querySelectorAll('input[name="paymentMethod"]').forEach(function (radio) {
        radio.addEventListener('change', function () {
          setSelectedMethod(this.value);
        });
      });

      setSelectedMethod(null);

      if (!paypalClientId || typeof paypal === 'undefined') {
        setStatus('PayPal is not configured yet. Please update the client id.');
      } else {
        paypal.Buttons({
          createOrder: function() {
            setStatus('');
            return fetch('/checkout/paypal/create-order', {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
            })
              .then(function(res) { return res.json(); })
              .then(function(data) {
                if (!data || !data.id) {
                  throw new Error(data && data.error ? data.error : 'Unable to create PayPal order.');
                }
                return data.id;
              })
              .catch(function(err) {
                setStatus(err.message || 'Unable to start PayPal checkout.');
                throw err;
              });
          },
          onApprove: function(data) {
            setStatus('Finalizing payment...');
            return fetch('/checkout/paypal/capture', {
              method: 'POST',
              headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
              body: new URLSearchParams({ orderId: data.orderID })
            })
              .then(function(res) { return res.json(); })
              .then(function(result) {
                if (result && result.redirectUrl) {
                  window.location.href = result.redirectUrl;
                  return;
                }
                throw new Error(result && result.error ? result.error : 'Payment capture failed.');
              })
              .catch(function(err) {
                setStatus(err.message || 'Payment capture failed.');
              });
          },
          onError: function(err) {
            setStatus('PayPal error: ' + (err && err.message ? err.message : 'Please try again.'));
          }
        }).render('#paypal-button-container');
      }

      if (!stripePublishableKey || !stripe) {
        setStripeStatus('Stripe is not configured yet. Please update the publishable key.');
      }

      if (stripeButton) {
        stripeButton.addEventListener('click', function () {
          setStripeStatus('');
          if (!stripe) {
            setStripeStatus('Stripe is not configured yet.');
            return;
          }

          stripeButton.disabled = true;

          fetch('/checkout/stripe/create-session', {
            method: 'POST',
            headers: { 'Content-Type': 'application/x-www-form-urlencoded' }
          })
            .then(function (res) { return res.json(); })
            .then(function (data) {
              if (!data || !data.id) {
                throw new Error(data && data.error ? data.error : 'Unable to start Stripe checkout.');
              }
              return stripe.redirectToCheckout({ sessionId: data.id });
            })
            .then(function (result) {
              if (result && result.error) {
                throw new Error(result.error.message || 'Stripe redirect failed.');
              }
            })
            .catch(function (err) {
              setStripeStatus(err.message || 'Stripe checkout failed.');
              stripeButton.disabled = false;
            });
        });
      }
    })();
  </script>
</body>
</html>
