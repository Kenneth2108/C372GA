<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Refund Invoice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <%- include('partials/admin_navbar') %>

  <main class="my-4">
    <div class="container">
      <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
        <div>
          <h2 class="mb-1">Refund Invoice</h2>
          <p class="text-muted mb-0">Refund ID: <strong><%= refund.id %></strong></p>
          <p class="text-muted mb-0">Invoice #: <strong><%= refund.invoiceNumber %></strong></p>
        </div>

        <div class="d-flex gap-2">
          <button class="btn btn-outline-secondary" onclick="window.print()">Print</button>
          <a href="/admin/refunds" class="btn btn-primary">Back to Refunds</a>
        </div>
      </div>

      <div class="row g-4">
        <div class="col-lg-8">
          <div class="card shadow-sm border-0">
            <div class="card-body">
              <h5 class="card-title mb-3">Refund Details</h5>

              <dl class="row mb-0">
                <dt class="col-sm-4">Refund Amount</dt>
                <dd class="col-sm-8">$<%= Number(refund.amount || 0).toFixed(2) %> <%= refund.currency || '' %></dd>

                <dt class="col-sm-4">Refund Status</dt>
                <dd class="col-sm-8"><%= refund.status || 'UNKNOWN' %></dd>

                <dt class="col-sm-4">Refund Date</dt>
                <dd class="col-sm-8"><%= refund.createdAt ? new Date(refund.createdAt).toLocaleString() : '-' %></dd>

                <dt class="col-sm-4">Refund Reason</dt>
                <dd class="col-sm-8"><%= refund.refundReason ? refund.refundReason : '-' %></dd>
              </dl>
            </div>
          </div>

          <div class="card shadow-sm border-0 mt-4">
            <div class="card-body">
              <h5 class="card-title mb-3">Refunded Items</h5>
              <% if (refundItems && refundItems.length) { %>
                <div class="table-responsive">
                  <table class="table table-sm align-middle">
                    <thead class="table-light">
                      <tr>
                        <th>Product ID</th>
                        <th class="text-center">Qty</th>
                        <th class="text-end">Unit Price</th>
                        <th class="text-end">Line Total</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% refundItems.forEach(function(item){ 
                           const qty = Number(item.quantity || 0);
                           const price = Number(item.unitPrice || 0);
                           const line = qty * price;
                      %>
                        <tr>
                          <td><%= item.productId %></td>
                          <td class="text-center"><%= qty %></td>
                          <td class="text-end">$<%= price.toFixed(2) %></td>
                          <td class="text-end">$<%= line.toFixed(2) %></td>
                        </tr>
                      <% }) %>
                    </tbody>
                  </table>
                </div>
              <% } else { %>
                <p class="text-muted mb-0">No item details recorded for this refund.</p>
              <% } %>
            </div>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="card shadow-sm border-0">
            <div class="card-body">
              <h5 class="card-title mb-3">Order Summary</h5>
              <%
                const refundedToDateValue = Number(refund.refundedToDate || 0);
                const orderTotalValue = Number(refund.total || 0);
                const remainingValue = Math.max(0, orderTotalValue - refundedToDateValue);
              %>
              <ul class="list-unstyled mb-3">
                <li class="d-flex justify-content-between text-muted mb-2">
                  <span>Order Total</span>
                  <span>$<%= orderTotalValue.toFixed(2) %></span>
                </li>
                <li class="d-flex justify-content-between text-muted">
                  <span>Refunded Total (to date)</span>
                  <span>$<%= refundedToDateValue.toFixed(2) %></span>
                </li>
                <li class="d-flex justify-content-between text-muted">
                  <span>Remaining Balance</span>
                  <span>$<%= remainingValue.toFixed(2) %></span>
                </li>
              </ul>

              <hr>

              <h6 class="mb-2">Customer</h6>
              <div class="text-muted"><%= refund.username %></div>
              <div class="text-muted"><%= refund.email %></div>
              <% if (refund.contact) { %>
                <div class="text-muted">Contact: <%= refund.contact %></div>
              <% } %>
              <div class="text-muted mt-2">
                Order Date: <%= refund.orderCreatedAt ? new Date(refund.orderCreatedAt).toLocaleString() : '-' %>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <style>
    html { scroll-behavior: smooth; }
    body { min-height: 100vh; display: flex; flex-direction: column; background: #f5f7fb; }
    main { flex: 1 0 auto; }
    footer { flex-shrink: 0; margin-top: auto; }

    .navbar {
      background: linear-gradient(90deg, #ff8db8, #ff6fa3);
    }
    .navbar-brand, .nav-link {
      color: white !important;
      font-weight: 500;
    }
    .nav-link:hover {
      background-color: #ff8db8;
      border-radius: 6px;
    }

    .app-footer { background-color: #0b2131; color: #e6edf3; }
    .app-footer a { color: #e6edf3; text-decoration: none; }
    .app-footer a:hover { text-decoration: underline; }
    .app-footer-gradient {
      height: 4px;
      background: linear-gradient(
        90deg,
        var(--bs-primary, #0d6efd),
        var(--bs-info, #0dcaf0),
        var(--bs-success, #198754),
        var(--bs-warning, #ffc107),
        var(--bs-danger, #dc3545)
      );
    }
    .app-footer-inner { font-size: .95rem; }

    @media print {
      nav, .btn, a.btn, footer { display: none !important; }
      body { margin: 0; background: #fff; }
    }
  </style>

  <%- include('partials/footer') %>
</body>
</html>
