<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <title>Refund Order</title>
  <style>
    body {
      min-height: 100vh;
      background: #fff6fb;
      font-family: "Segoe UI", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      display: flex;
      flex-direction: column;
    }
    main { flex: 1 0 auto; }
    .navbar {
      background: linear-gradient(90deg, #ff8db8, #ff6fa3);
    }
    .navbar-brand {
      color: white;
      font-weight: 700;
    }
    .nav-link {
      color: white !important;
      border-radius: 8px;
      padding: 8px 14px;
    }
    .nav-link:hover {
      background: #ff8db8;
    }
    .page-card {
      background: #fff;
      border-radius: 22px;
      box-shadow: 0 20px 45px rgba(255, 111, 163, 0.18), 0 3px 10px rgba(255, 111, 163, 0.12);
    }
    .hero-intro {
      background: linear-gradient(135deg, #ffe7f3 0%, #fff2f9 50%, #f6f1ff 100%);
      border-radius: 22px;
      padding: 1.5rem 2rem;
      border: 1px solid rgba(255, 111, 163, .25);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-wrap: wrap;
      position: relative;
      overflow: hidden;
    }
    .hero-intro::after {
      content: "";
      position: absolute;
      width: 180px;
      height: 180px;
      background: radial-gradient(circle at top right, rgba(255, 143, 223, .45), transparent 70%);
      top: -80px;
      right: -60px;
      border-radius: 50%;
    }
    .hero-icon {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg, #ff6fa3, #ff9fd3);
      color: #fff;
      font-size: 1.4rem;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 12px 25px rgba(255, 111, 163, .35);
      font-weight: 700;
    }
    .hero-text h2 { margin-bottom: .4rem; font-weight: 700; color: #101828; }
    .hero-text p { margin: 0; color: #475467; }
    .hero-badge {
      background: rgba(255, 111, 163, .15);
      color: #ff6fa3;
      padding: .25rem .85rem;
      border-radius: 999px;
      font-size: .8rem;
      text-transform: uppercase;
      letter-spacing: .08em;
    }
  </style>
</head>
<body>
  <%- include('partials/admin_navbar') %>

  <main class="container my-4">
    <div class="page-card p-4">
      <div class="hero-intro">
        <div class="hero-icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" width="28" height="28" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12a9 9 0 1 0 3-6.7"></path>
            <path d="M3 3v6h6"></path>
            <path d="M7 12h10"></path>
          </svg>
        </div>
        <div class="hero-text">
          <h2 class="mb-1">Refund Order</h2>
          <p>Process refunds, restock items, and keep inventory accurate.</p>
        </div>
        <span class="hero-badge">Refunds</span>
        <a href="/admin/orders" class="btn btn-outline-secondary btn-sm ms-auto">Back to Orders</a>
      </div>

      <% if (messages && messages.length) { %>
        <div class="alert alert-warning">
          <% messages.forEach(function(message){ %>
            <div><%= message %></div>
          <% }) %>
        </div>
      <% } %>

      <% if (!order) { %>
        <div class="alert alert-danger">Order not found.</div>
      <% } else { %>
        <% const remainingAmountValue = Number(remainingAmount || 0); %>
        <% const isRefundable = remainingAmountValue > 0; %>
        <div class="refund-status-pill <%= isRefundable ? 'refund-status-ok' : 'refund-status-none' %>">
          <span class="refund-status-icon" aria-hidden="true">
            <% if (isRefundable) { %>
              <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M20 7L9 18l-5-5"></path>
              </svg>
            <% } else { %>
              <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M12 8v4m0 4h.01"></path>
                <circle cx="12" cy="12" r="9"></circle>
              </svg>
            <% } %>
          </span>
          <span><%= isRefundable ? 'Refundable balance available.' : 'No refundable balance remaining.' %></span>
        </div>
        <div class="refund-header-summary">
          <div class="refund-header-item">
            <div class="refund-header-label">Order Total</div>
            <div class="refund-header-value">$<%= Number(order.total || 0).toFixed(2) %></div>
          </div>
          <div class="refund-header-item">
            <div class="refund-header-label">Refundable Balance</div>
            <div class="refund-header-value">$<%= Number(remainingAmount || 0).toFixed(2) %></div>
          </div>
          <div class="refund-header-item">
            <div class="refund-header-label">Refund Status</div>
            <div class="refund-header-value">
              <span class="refund-status-badge <%= isRefundable ? 'refund-status-badge-ok' : 'refund-status-badge-none' %>">
                <%= isRefundable ? 'Refundable' : 'No Balance' %>
              </span>
            </div>
          </div>
        </div>
        <div class="mb-3">
          <label class="form-label">Invoice Number</label>
          <input type="text" class="form-control" readonly value="<%= order.invoiceNumber || order.invoice_number || '' %>">
        </div>

        <div class="mb-3">
          <label class="form-label">Order Total</label>
          <input type="text" class="form-control" readonly value="$<%= Number(order.total || 0).toFixed(2) %>">
        </div>

        <div class="mb-3">
          <label class="form-label">Remaining Refundable Amount</label>
          <input type="text" class="form-control" readonly value="$<%= Number(remainingAmount || 0).toFixed(2) %>">
        </div>

        <div class="mb-3">
          <button
            class="btn btn-outline-secondary btn-sm"
            type="button"
            data-bs-toggle="collapse"
            data-bs-target="#paymentDetails"
            aria-expanded="false"
            aria-controls="paymentDetails">
            Payment details
          </button>
          <div class="collapse mt-3" id="paymentDetails">
            <div class="card card-body">
              <% const paymentMethodRaw = String(order.paymentMethod || order.payment_method || '').toLowerCase(); %>
              <% const isStripePayment = paymentMethodRaw === 'stripe'; %>
              <label class="form-label"><%= isStripePayment ? 'Stripe Payment Intent ID' : 'PayPal Capture ID' %></label>
              <input
                type="text"
                class="form-control"
                readonly
                value="<%= isStripePayment ? (order.stripePaymentIntentId || order.stripe_payment_intent_id || '') : (order.paypalCaptureId || order.paypal_capture_id || '') %>">
            </div>
          </div>
        </div>

        <form action="/admin/orders/<%= order.id %>/refund" method="POST">
          <div class="mb-3">
            <label for="refundType" class="form-label">Refund Type</label>
            <select id="refundType" name="refundType" class="form-select">
              <option value="full_restock" selected>Full refund (restock all items)</option>
              <option value="full_no_restock">Full refund (don't restock all items)</option>
              <option value="custom">Customize refund</option>
            </select>
          </div>

          <div class="mb-3">
            <label for="refundAmount" class="form-label">Refund Amount (SGD)</label>
            <input
              type="number"
              step="0.01"
              min="0.01"
              max="<%= Number(remainingAmount || 0).toFixed(2) %>"
              id="refundAmount"
              name="amount"
              class="form-control"
              value="<%= Number(remainingAmount || 0).toFixed(2) %>"
              data-remaining="<%= Number(remainingAmount || 0).toFixed(2) %>"
              readonly
              required>
          </div>

          <div class="mb-3">
            <div class="refund-summary">
              <div class="refund-summary-item refund-summary-total">
                <span class="refund-summary-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M3 7h18M5 7V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v2M5 7v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V7"></path>
                    <path d="M7 11h4"></path>
                  </svg>
                </span>
                <div class="refund-summary-label">Refund total</div>
                <div class="refund-summary-value" id="refundSummaryAmount">$0.00</div>
              </div>
              <div class="refund-summary-item refund-summary-restock">
                <span class="refund-summary-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 12a9 9 0 1 1-3-6.7"></path>
                    <path d="M21 3v6h-6"></path>
                  </svg>
                </span>
                <div class="refund-summary-label">Restock qty</div>
                <div class="refund-summary-value" id="refundSummaryRestock">0</div>
              </div>
              <div class="refund-summary-item refund-summary-no-restock">
                <span class="refund-summary-icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="16" height="16" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M6 6l12 12"></path>
                    <path d="M18 6l-5 5m-2 2l-5 5"></path>
                  </svg>
                </span>
                <div class="refund-summary-label">Refund-only qty</div>
                <div class="refund-summary-value" id="refundSummaryNoRestock">0</div>
              </div>
            </div>
          </div>

          <div id="partialRefundSection" class="mb-3 d-none">
            <div class="mb-2 text-muted">Select quantities to refund and restock.</div>
            <% if (orderItems && orderItems.length) { %>
              <div class="table-responsive">
                <table class="table table-sm align-middle">
                  <thead>
                    <tr>
                      <th>Item</th>
                      <th class="text-end">Unit Price</th>
                      <th class="text-end">Ordered Qty</th>
                      <th class="text-end">Refunded Qty</th>
                      <th class="text-end">Remaining Qty</th>
                      <th class="text-end">Refund + Restock</th>
                      <th class="text-end">Refund Only</th>
                    </tr>
                  </thead>
                  <tbody>
                    <% orderItems.forEach(function(item){ %>
                      <tr>
                        <td><%= item.productName %></td>
                        <td class="text-end">$<%= Number(item.refundUnitPrice || item.unitPrice || 0).toFixed(2) %></td>
                        <td class="text-end"><%= Number(item.quantity || 0) %></td>
                        <td class="text-end"><%= Number(item.refundedQty || 0) %></td>
                        <td class="text-end remaining-qty"><%= Number(item.remainingQty || 0) %></td>
                        <td class="text-end">
                          <input type="hidden" name="refundProductId" value="<%= item.productId %>">
                          <input
                            type="number"
                            name="refundQtyRestock"
                            class="form-control form-control-sm text-end refund-qty refund-qty-restock"
                            min="0"
                            max="<%= Number(item.remainingQty || 0) %>"
                            step="1"
                            value="0"
                            data-price="<%= Number(item.refundUnitPriceExact || item.refundUnitPrice || item.unitPrice || 0).toFixed(4) %>">
                        </td>
                        <td class="text-end">
                          <input
                            type="number"
                            name="refundQtyNoRestock"
                            class="form-control form-control-sm text-end refund-qty refund-qty-no-restock"
                            min="0"
                            max="<%= Number(item.remainingQty || 0) %>"
                            step="1"
                            value="0"
                            data-price="<%= Number(item.refundUnitPriceExact || item.refundUnitPrice || item.unitPrice || 0).toFixed(4) %>">
                        </td>
                      </tr>
                    <% }) %>
                  </tbody>
                </table>
              </div>
            <% } else { %>
              <div class="alert alert-info">No items found for this order.</div>
            <% } %>
          </div>

          <div class="mb-3">
            <label for="refundReason" class="form-label">Refund Reason</label>
            <textarea
              id="refundReason"
              name="refundReason"
              class="form-control"
              rows="3"
              maxlength="500"
              placeholder="Add a short reason for this refund (optional)."></textarea>
          </div>

          <div class="d-flex gap-2">
            <button type="submit" class="btn btn-primary">Submit Refund</button>
            <a href="/admin/orders" class="btn btn-secondary">Cancel</a>
          </div>
        </form>
        <% if (!isRefundable) { %>
          <style>
            .refund-disabled [name="refundType"],
            .refund-disabled [name="amount"],
            .refund-disabled .refund-qty,
            .refund-disabled button[type="submit"] {
              pointer-events: none;
              opacity: .6;
            }
          </style>
          <script>
            document.addEventListener('DOMContentLoaded', function () {
              const form = document.querySelector('form[action^="/admin/orders/"][action$="/refund"]');
              if (form) form.classList.add('refund-disabled');
            });
          </script>
        <% } %>
      <% } %>
    </div>
  </main>

  <style>
    .refund-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 12px;
      padding: 12px;
      border: 1px solid #ffe1ef;
      border-radius: 12px;
      background: linear-gradient(135deg, #fff2f9, #ffffff);
      box-shadow: 0 6px 16px rgba(255, 111, 163, 0.08);
    }

    .refund-summary-item {
      padding: 10px 12px;
      border-radius: 10px;
      background: #fff;
      border: 1px solid #ffe6f2;
      position: relative;
      overflow: hidden;
      transition: transform .18s ease, box-shadow .18s ease;
    }

    .refund-summary-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px;
      height: 28px;
      border-radius: 8px;
      margin-bottom: 6px;
      color: inherit;
      background: rgba(255, 111, 163, 0.08);
    }

    .refund-summary-label {
      font-size: .8rem;
      letter-spacing: .02em;
      text-transform: uppercase;
      color: #b98ca3;
      margin-bottom: 4px;
    }

    .refund-summary-value {
      font-size: 1.05rem;
      font-weight: 600;
      color: #111827;
    }

    .refund-summary-item::after {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      background: #ffd0e3;
    }

    .refund-summary-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(255, 111, 163, 0.18);
    }

    .refund-summary-total::after { background: #ff6fa3; }
    .refund-summary-restock::after { background: #f4a3c6; }
    .refund-summary-no-restock::after { background: #c8a2b5; }

    .refund-summary-total {
      background: linear-gradient(180deg, rgba(255, 111, 163, 0.12), #ffffff);
    }

    .refund-summary-restock {
      background: linear-gradient(180deg, rgba(244, 163, 198, 0.18), #ffffff);
    }

    .refund-summary-no-restock {
      background: linear-gradient(180deg, rgba(200, 162, 181, 0.18), #ffffff);
    }

    .refund-header-summary {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      padding: 12px;
      border-radius: 12px;
      background: linear-gradient(135deg, rgba(255, 111, 163, 0.16), rgba(255, 210, 228, 0.2), #ffffff);
      border: 1px solid #ffe1ef;
      margin-bottom: 16px;
    }

    .refund-header-item {
      padding: 10px 12px;
      border-radius: 10px;
      background: #fff;
      border: 1px solid #ffe6f2;
      position: relative;
      overflow: hidden;
      transition: transform .18s ease, box-shadow .18s ease;
    }

    .refund-header-label {
      font-size: .75rem;
      letter-spacing: .05em;
      text-transform: uppercase;
      color: #b98ca3;
      margin-bottom: 4px;
    }

    .refund-header-value {
      font-size: 1.05rem;
      font-weight: 600;
      color: #111827;
    }

    .refund-header-item::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      height: 3px;
      width: 100%;
      background: linear-gradient(90deg, #ff6fa3, #ff9fd3, #c8a2b5);
    }

    .refund-header-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 24px rgba(255, 111, 163, 0.2);
    }

    .refund-status-pill {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 600;
      margin-bottom: 16px;
      border: 1px solid transparent;
      background: #ffe9f3;
      color: #b24d76;
      box-shadow: 0 8px 20px rgba(255, 111, 163, 0.18);
    }

    .refund-status-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .refund-status-ok {
      background: #ffe3f0;
      color: #b24d76;
      border-color: #ffc2dc;
    }

    .refund-status-none {
      background: #f7e9f1;
      color: #8b5d75;
      border-color: #ecd6e1;
    }

    .refund-status-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: .75rem;
      letter-spacing: .02em;
      text-transform: uppercase;
    }

    .refund-status-badge-ok {
      background: #ffd6e7;
      color: #c73c73;
      box-shadow: inset 0 0 0 1px rgba(199, 60, 115, 0.2);
    }

    .refund-status-badge-none {
      background: #f1dfe8;
      color: #8b5d75;
      box-shadow: inset 0 0 0 1px rgba(139, 93, 117, 0.2);
    }
  </style>

  <%- include('partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function () {
      const refundType = document.getElementById('refundType');
      const partialSection = document.getElementById('partialRefundSection');
      const refundAmount = document.getElementById('refundAmount');
      const qtyInputs = Array.from(document.querySelectorAll('.refund-qty'));
      const rowInputs = Array.from(document.querySelectorAll('tbody tr')).map((row) => {
        const restock = row.querySelector('.refund-qty-restock');
        const noRestock = row.querySelector('.refund-qty-no-restock');
        const maxValue = Number(restock?.max || noRestock?.max || 0);
        return { restock, noRestock, maxValue };
      });
      const remainingAmount = Number(refundAmount?.dataset?.remaining || 0);

      function formatMoney(value) {
        return Number(value || 0).toFixed(2);
      }

      function getPartialTotal() {
        return qtyInputs.reduce((sum, input) => {
          const qty = Number(input.value) || 0;
          const price = Number(input.dataset.price) || 0;
          return sum + (qty * price);
        }, 0);
      }

      function getQtyTotals() {
        return rowInputs.reduce((acc, row) => {
          const restockValue = Number(row.restock?.value || 0);
          const noRestockValue = Number(row.noRestock?.value || 0);
          acc.restock += restockValue;
          acc.noRestock += noRestockValue;
          return acc;
        }, { restock: 0, noRestock: 0 });
      }

      function getRemainingQtyTotal() {
        const remainingCells = Array.from(document.querySelectorAll('.remaining-qty'));
        return remainingCells.reduce((sum, cell) => {
          const value = Number(cell.textContent || 0);
          return sum + (Number.isFinite(value) ? value : 0);
        }, 0);
      }

      function syncSummaryBar() {
        const amountEl = document.getElementById('refundSummaryAmount');
        const restockEl = document.getElementById('refundSummaryRestock');
        const noRestockEl = document.getElementById('refundSummaryNoRestock');
        if (!amountEl || !restockEl || !noRestockEl) return;

        if (refundType && refundType.value === 'custom') {
          const totals = getQtyTotals();
          amountEl.textContent = `$${formatMoney(Math.min(getPartialTotal(), remainingAmount))}`;
          restockEl.textContent = String(totals.restock);
          noRestockEl.textContent = String(totals.noRestock);
          return;
        }

        amountEl.textContent = `$${formatMoney(remainingAmount)}`;
        if (refundType && refundType.value === 'full_no_restock') {
          restockEl.textContent = '0';
          noRestockEl.textContent = String(getRemainingQtyTotal());
          return;
        }

        restockEl.textContent = String(getRemainingQtyTotal());
        noRestockEl.textContent = '0';
      }

      function syncRefundAmount() {
        if (!refundAmount) return;
        if (refundType && refundType.value === 'custom') {
          const partialTotal = getPartialTotal();
          refundAmount.value = formatMoney(Math.min(partialTotal, remainingAmount));
        } else {
          refundAmount.value = formatMoney(remainingAmount);
        }
        syncSummaryBar();
      }

      function clampRow(row, changedField) {
        if (!row || (!row.restock && !row.noRestock)) return;
        const maxValue = Number(row.maxValue || 0);
        const restockValue = Number(row.restock?.value || 0);
        const noRestockValue = Number(row.noRestock?.value || 0);
        const total = restockValue + noRestockValue;
        if (total <= maxValue) return;

        const remaining = Math.max(maxValue - (changedField === 'restock' ? noRestockValue : restockValue), 0);
        if (changedField === 'restock' && row.restock) {
          row.restock.value = remaining;
        }
        if (changedField === 'noRestock' && row.noRestock) {
          row.noRestock.value = remaining;
        }
      }

      function togglePartialSection() {
        if (!refundType || !partialSection) return;
        const isPartial = refundType.value === 'custom';
        partialSection.classList.toggle('d-none', !isPartial);
        syncRefundAmount();
      }

      if (refundType) {
        refundType.addEventListener('change', togglePartialSection);
      }

      rowInputs.forEach((row) => {
        if (row.restock) {
          row.restock.addEventListener('input', () => {
            clampRow(row, 'restock');
            syncRefundAmount();
          });
        }
        if (row.noRestock) {
          row.noRestock.addEventListener('input', () => {
            clampRow(row, 'noRestock');
            syncRefundAmount();
          });
        }
      });

      togglePartialSection();
      syncSummaryBar();
    })();
  </script>
</body>
</html>
