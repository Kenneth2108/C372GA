<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>FluffyFriend ‚Äî Orders</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: #fff6fb;
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    main {
      flex: 1;
      padding-bottom: 2rem;
    }
    .navbar {
      background: linear-gradient(90deg, #ff8db8, #ff6fa3);
    }
    .navbar-brand {
      color: white;
      font-weight: 700;
    }
    .nav-link {
      color: white !important;
      border-radius: 8px;
      padding: 8px 14px;
    }
    .nav-link:hover {
      background: #ff8db8;
    }
    .orders-shell {
      background: #fff;
      border-radius: 26px;
      padding: 1.5rem;
      box-shadow: 0 30px 70px rgba(0, 0, 0, 0.08);
    }
    .filter-bar {
      background: #ffe3f0;
      border-radius: 16px;
      padding: 1rem;
      margin-bottom: 1.5rem;
    }
    .order-header {
      background: #ffe3f0;
      border-radius: 16px;
      padding: 12px 16px;
      margin-bottom: 1rem;
    }
    .badge-pill {
      border-radius: 999px;
      background: rgba(255,111,163,0.15);
      color: #ff6fa3;
      padding: 4px 10px;
      font-size: 0.8rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="container d-flex justify-content-between">
      <a class="navbar-brand" href="/">üêæ FluffyFriend</a>
      <div>
        <a class="nav-link d-inline" href="/admin">Admin</a>
        <a class="nav-link d-inline" href="/admin/users">Users</a>
        <a class="nav-link d-inline" href="/logout">Logout</a>
      </div>
    </div>
  </nav>

  <main class="container my-4">
    <% if (success && success.length) { %>
      <div class="alert alert-success"><%= success[0] %></div>
    <% } %>
    <% if (error && error.length) { %>
      <div class="alert alert-danger"><%= error[0] %></div>
    <% } %>

    <div class="d-flex justify-content-between align-items-center mb-3">
      <div>
        <h2 class="fw-bold mb-0">Orders</h2>
        <p class="text-muted mb-0">Review completed checkouts</p>
      </div>
      <a href="/admin" class="btn btn-outline-secondary">Back to Dashboard</a>
    </div>

    <div class="orders-shell">
      <div class="filter-bar">
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label small text-muted mb-1">Filter by username</label>
            <input type="text" class="form-control order-filter" data-filter-key="username" placeholder="e.g. kenneth">
          </div>
          <div class="col-md-4">
            <label class="form-label small text-muted mb-1">Filter by invoice number</label>
            <input type="text" class="form-control order-filter" data-filter-key="invoice" placeholder="e.g. INV-1234">
          </div>
          <div class="col-md-4">
            <label class="form-label small text-muted mb-1">Filter by email</label>
            <input type="text" class="form-control order-filter" data-filter-key="email" placeholder="e.g. user@email.com">
          </div>
        </div>
      </div>

      <% if (!orders || !orders.length) { %>
        <p class="text-center text-muted mb-0">No orders yet.</p>
      <% } else { %>
        <% orders.forEach(function(order) { %>
          <div class="order-block" data-username="<%= (order.username || '').toLowerCase() %>" data-email="<%= (order.email || '').toLowerCase() %>" data-invoice="<%= (order.invoice_number || '').toLowerCase() %>">
            <div class="order-header d-flex flex-wrap justify-content-between align-items-center">
              <div>
                <div class="badge-pill mb-1"><%= order.invoice_number %></div>
                <h5 class="mb-0"><%= order.username || 'Customer' %></h5>
                <small class="text-muted"><%= order.email || '' %></small>
              </div>
              <div class="text-end">
                <div class="fw-semibold">$<%= Number(order.total || 0).toFixed(2) %></div>
                <small class="text-muted"><%= new Date(order.created_at).toLocaleString() %></small>
              </div>
            </div>
            <div class="table-responsive mb-4">
              <table class="table table-sm align-middle">
                <thead>
                  <tr>
                    <th>Product</th>
                    <th class="text-center">Qty</th>
                    <th class="text-end">Price</th>
                    <th class="text-end">Line Total</th>
                  </tr>
                </thead>
                <tbody>
                  <% (order.items || []).forEach(function(item) { %>
                    <tr>
                      <td><%= item.product_name %></td>
                      <td class="text-center"><%= item.quantity %></td>
                      <td class="text-end">$<%= Number(item.price || 0).toFixed(2) %></td>
                      <td class="text-end">$<%= Number(item.line_total || 0).toFixed(2) %></td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </div>
          </div>
        <% }); %>
      <% } %>
    </div>
  </main>

  <%- include('partials/footer') %>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    (function () {
      const inputs = document.querySelectorAll('.order-filter');
      const blocks = document.querySelectorAll('.order-block');

      function applyFilters() {
        const filters = {};
        inputs.forEach((input) => {
          const key = input.dataset.filterKey;
          filters[key] = input.value.trim().toLowerCase();
        });

        blocks.forEach((block) => {
          let visible = true;
          Object.keys(filters).forEach((key) => {
            const filterVal = filters[key];
            if (filterVal && !(block.dataset[key] || '').includes(filterVal)) {
              visible = false;
            }
          });
          block.style.display = visible ? '' : 'none';
        });
      }

      inputs.forEach((input) => input.addEventListener('input', applyFilters));
    })();
  </script>
</body>
</html>
