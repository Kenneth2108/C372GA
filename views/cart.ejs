<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Your Cart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    /* Navbar */
    .navbar {
      background: linear-gradient(90deg, #ff8db8, #ff6fa3);
    }
    .navbar-brand {
      color: white;
      font-weight: 700;
      font-size: 1.3rem;
    }
    .navbar .nav-link {
      color: white !important;
      font-weight: 500;
      border-radius: 8px;
      padding: 8px 14px;
      transition: 0.3s ease;
    }
    .navbar .nav-link:hover {
      background-color: #ff8db8;
      color: #fff !important;
    }
    .navbar .navbar-toggler {
      border-color: rgba(255,255,255,.6);
    }
    .navbar .navbar-toggler-icon {
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 30 30'%3e%3cpath stroke='rgba(255,255,255,.9)' stroke-linecap='round' stroke-miterlimit='10' stroke-width='2' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
    }
    :root {
      color-scheme: light;
    }
    body {
      background: linear-gradient(180deg, #fff6fb 0%, #ffecf5 100%);
      font-family: 'Segoe UI', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .ff-main {
      flex: 1 0 auto;
      padding: 40px 0 80px;
    }
    .cart-hero {
      max-width: 640px;
      margin: 0 auto 32px;
    }
    .cart-hero .eyebrow-label {
      letter-spacing: 0.2em;
      text-transform: uppercase;
      font-size: 0.85rem;
      color: #ff6fa3;
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: inline-block;
    }
    .cart-hero h1 {
      font-weight: 700;
      color: #312631;
    }
    .cart-card,
    .empty-state {
      max-width: 1080px;
      margin: 0 auto;
      background: #fff;
      border-radius: 24px;
      padding: 32px;
      box-shadow: 0 25px 60px rgba(255, 111, 163, 0.18);
    }
    .cart-card {
      border: 1px solid #ffe1ee;
    }
    .empty-state {
      border: 1px dashed #ffb3cf;
      text-align: center;
    }
    .empty-state h3 {
      font-weight: 600;
    }
    .cart-table-wrapper {
      overflow-x: auto;
    }
    .cart-card table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }
    .cart-card thead th {
      border: none;
      background: transparent;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-size: 0.8rem;
      color: #ff6fa3;
      padding-bottom: 1rem;
    }
    .cart-card tbody td {
      border-bottom: 1px solid #f9ddeb;
      padding-top: 1.2rem;
      padding-bottom: 1.2rem;
      vertical-align: middle;
    }
    .cart-card tbody tr:last-child td {
      border-bottom: none;
    }
    .cart-card tbody tr:hover td {
      background-color: #fff7fb;
    }
    .product-image {
      width: 80px;
      height: 80px;
      object-fit: cover;
      border-radius: 18px;
      border: 1px solid #ffe1ee;
      background: #fff6fb;
    }
    .total-chip {
      background: #fff6fb;
      border-radius: 16px;
      padding: 14px 24px;
      color: #ff3d72;
      min-width: 210px;
      box-shadow: inset 0 0 0 1px #ffd7e8;
    }
    .total-chip span {
      display: block;
      font-size: 0.8rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #ff8db8;
      margin-bottom: 0.2rem;
    }
    .action-panel {
      display: flex;
      flex-direction: column;
      gap: 1.25rem;
      margin-top: 2rem;
    }
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
    }
    .action-buttons form {
      margin: 0;
    }
    .btn-pink {
      background-color: #ff6fa3;
      border: none;
      color: #fff;
    }
    .btn-pink:hover {
      background-color: #ff8db8;
      color: #fff;
    }
    .btn-outline-pink {
      border: 1px solid #ff6fa3;
      color: #ff6fa3;
    }
    .btn-outline-pink:hover {
      background-color: #ff6fa3;
      color: #fff;
    }
    .btn-warning {
      background-color: #ffbf47;
      border: none;
      color: #472a00;
    }
    .btn-warning:hover {
      background-color: #ffd677;
      color: #472a00;
    }
    .quantity-form {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
    }
    .quantity-controls {
      display: inline-flex;
      align-items: center;
      border: 1px solid #ffd7e8;
      border-radius: 999px;
      background: #fff;
      overflow: hidden;
    }
    .qty-btn {
      background: transparent;
      border: none;
      width: 36px;
      height: 36px;
      font-weight: 600;
      color: #ff6fa3;
    }
    .qty-btn:hover {
      background: #fff0f6;
    }
    .qty-input {
      width: 56px;
      border: none;
      text-align: center;
      font-weight: 600;
      color: #312631;
      background: transparent;
    }
    .qty-input:focus {
      outline: none;
      box-shadow: none;
    }
    .update-qty-btn {
      white-space: nowrap;
    }
    @media (min-width: 768px) {
      .action-panel {
        flex-direction: row;
        align-items: center;
        justify-content: space-between;
      }
    }
    @media (max-width: 768px) {
      .cart-card,
      .empty-state {
        padding: 24px;
      }
      .product-image {
        width: 64px;
        height: 64px;
      }
    }
    @media (max-width: 576px) {
      .quantity-form {
        flex-direction: column;
        gap: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <!-- Shared user navbar -->
  <%- include('partials/user_navbar') %>

  <main class="ff-main">
    <div class="container">
      <section class="cart-hero text-center">
        <span class="eyebrow-label">Your basket</span>
        <h1>Shopping Cart</h1>
        <p class="text-muted mb-0">Review every cute find before you complete your order.</p>
      </section>

      <% if (!cartItems || cartItems.length === 0) { %>
        <div class="empty-state">
          <h3>Your cart is still empty</h3>
          <p class="text-muted mb-4">Browse the catalog to add fluffy surprises to your basket.</p>
          <a href="/UserProducts" class="btn btn-pink px-4">Browse Products</a>
        </div>
      <% } else { %>
        <% let total = 0; %>
        <div class="cart-card">
          <div class="cart-table-wrapper">
            <table class="table align-middle mb-0">
              <thead>
                <tr>
                  <th>Product</th>
                  <th class="text-center" style="width:140px;">Image</th>
                  <th class="text-center" style="width:120px;">Price</th>
                  <th class="text-center" style="width:180px;">Quantity</th>
                  <th class="text-end" style="width:150px;">Line Total</th>
                  <th class="text-center" style="width:120px;">Action</th>
                </tr>
              </thead>
              <tbody>
                <% for (const item of cartItems) {
                     const lineTotal = (Number(item.price) || 0) * (Number(item.quantity) || 0);
                     total += lineTotal;
                %>
                  <tr>
                    <td class="fw-semibold"><%= item.productName %></td>
                    <td class="text-center">
                      <%
                        const rawImage = item.image || '';
                        let imageSrc = '';
                        if (rawImage) {
                          if (/^https?:\/\//i.test(rawImage)) {
                            imageSrc = rawImage;
                          } else if (rawImage.startsWith('/')) {
                            imageSrc = rawImage;
                          } else if (rawImage.startsWith('images/')) {
                            imageSrc = '/' + rawImage;
                          } else if (rawImage.startsWith('products/')) {
                            imageSrc = '/images/' + rawImage;
                          } else {
                            imageSrc = '/images/products/' + rawImage;
                          }
                        }
                      %>
                      <% if (imageSrc) { %>
                        <img src="<%= imageSrc %>" alt="<%= item.productName %> image" class="product-image">
                      <% } else { %>
                        <span class="text-muted small">No image</span>
                      <% } %>
                    </td>
                    <td class="text-center">$<%= (Number(item.price) || 0).toFixed(2) %></td>
                    <td class="text-center">
                      <form action="/cart/update" method="POST" class="quantity-form">
                        <input type="hidden" name="fineId" value="<%= item.product_id %>">
                        <div class="quantity-controls">
                          <button type="button" class="qty-btn" data-step="-1" aria-label="Decrease quantity">-</button>
                          <input type="number" name="quantity" min="0" value="<%= item.quantity %>" class="qty-input" inputmode="numeric">
                          <button type="button" class="qty-btn" data-step="1" aria-label="Increase quantity">+</button>
                        </div>
                        <button type="submit" class="btn btn-outline-secondary btn-sm update-qty-btn">Update</button>
                      </form>
                    </td>
                    <td class="text-end">$<%= lineTotal.toFixed(2) %></td>
                    <td class="text-center">
                      <form action="/cart/remove" method="POST" class="d-inline m-0">
                        <input type="hidden" name="fineId" value="<%= item.product_id %>">
                        <button type="submit" class="btn btn-danger btn-sm px-3">Remove</button>
                      </form>
                    </td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>

          <div class="action-panel">
            <div class="total-chip">
              <span>Total</span>
              <strong>$<%= total.toFixed(2) %></strong>
            </div>

            <div class="action-buttons">
              <a href="/" class="btn btn-outline-pink px-4">Back to Home</a>

              <form action="/cart/clear" method="POST" class="d-inline">
                <button type="submit" class="btn btn-warning px-4">Clear Cart</button>
              </form>

              <form action="/checkout" method="POST" class="d-inline">
                <button type="submit" class="btn btn-pink px-4">Checkout</button>
              </form>
            </div>
          </div>
        </div>
      <% } %>
    </div>
  </main>

  <%- include('partials/footer') %>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    document.querySelectorAll('.quantity-form').forEach(function(form) {
      var input = form.querySelector('.qty-input');
      form.querySelectorAll('.qty-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var step = parseInt(btn.dataset.step, 10) || 0;
          var current = parseInt(input.value, 10);
          if (isNaN(current)) current = 0;
          var nextValue = current + step;
          if (nextValue < 0) nextValue = 0;
          input.value = nextValue;
        });
      });
    });
  </script>
</body>
</html>
