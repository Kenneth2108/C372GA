<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title><%= title %></title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://unpkg.com/event-source-polyfill"></script>

  <style>
    :root { color-scheme: light; }

    body {
      background: radial-gradient(circle at top, #ffe8f3 0%, #fff6fb 45%, #ffeef6 100%);
      font-family: "Segoe UI", sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    .ff-main {
      flex: 1 0 auto;
      padding: 40px 0 80px;
    }

    .checkout-hero {
      max-width: 760px;
      margin: 0 auto 28px;
      text-align: center;
    }

    .checkout-hero .eyebrow-label {
      letter-spacing: 0.2em;
      text-transform: uppercase;
      font-size: 0.85rem;
      color: #ff6fa3;
      font-weight: 700;
      margin-bottom: 0.5rem;
      display: inline-block;
    }

    .checkout-hero h1 {
      font-weight: 800;
      color: #312631;
      margin-bottom: 0.35rem;
    }

    .checkout-hero p {
      color: #6b5566;
      margin: 0;
    }

    .nets-card {
      background: #fff;
      border-radius: 24px;
      padding: 28px;
      box-shadow: 0 25px 60px rgba(255, 111, 163, 0.18);
      border: 1px solid #ffe1ee;
    }

    .qr-box {
      background: #fff7fb;
      border: 1px solid #ffd7e8;
      border-radius: 20px;
      padding: 22px;
      text-align: center;
    }

    .qr-img {
      width: min(320px, 100%);
      height: auto;
      border-radius: 16px;
      background: #fff;
      border: 1px solid #ffe1ee;
      padding: 10px;
    }

    .info-img {
      width: min(420px, 100%);
      height: auto;
      border-radius: 16px;
      border: 1px solid #ffe1ee;
      background: #fff;
      padding: 10px;
    }

    .status-pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      background: #fff1f7;
      color: #b4233a;
      border: 1px solid #ffc2d1;
      padding: 8px 14px;
      border-radius: 999px;
      font-weight: 700;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      font-size: 0.78rem;
    }

    .status-pill.ok {
      background: #eafff4;
      color: #087443;
      border-color: #b7f0d2;
    }

    .subtle {
      color: #6b5566;
      font-size: 0.95rem;
    }

    .timer {
      font-weight: 800;
      color: #ff3d72;
      font-size: 1.05rem;
    }

    .btn-outline-pink {
      border: 1px solid #ff6fa3;
      color: #ff6fa3;
    }
    .btn-outline-pink:hover {
      background-color: #ff6fa3;
      color: #fff;
    }

    .btn-pink {
      background: #ff6fa3;
      border: 1px solid #ff6fa3;
      color: #fff;
    }
    .btn-pink:hover {
      background: #ff3d72;
      border-color: #ff3d72;
      color: #fff;
    }

    #status {
      margin: 0;
    }

    .mini-row {
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      gap: 10px;
      margin-top: 14px;
    }

    .mini {
      flex: 1 1 220px;
      background: #fff;
      border: 1px solid #ffe1ee;
      border-radius: 18px;
      padding: 12px 14px;
    }

    .mini .label {
      font-size: 0.85rem;
      color: #8b7283;
      margin-bottom: 4px;
    }

    .mini .value {
      font-weight: 800;
      color: #312631;
      word-break: break-word;
    }
  </style>
</head>

<body>
  <%- include('partials/user_navbar') %>

  <main class="ff-main">
    <div class="container">
      <section class="checkout-hero">
        <span class="eyebrow-label">NETS QR Payment</span>
        <h1>Scan the QR Code</h1>
        <p class="subtle">Scan using your supported banking app to complete payment.</p>
      </section>

      <div class="row g-4 justify-content-center">
        <div class="col-lg-7">
          <div class="nets-card">
            <div class="d-flex flex-column flex-sm-row align-items-start align-items-sm-center justify-content-between gap-3 mb-3">
              <div>
                <div class="status-pill" id="status-pill">Waiting for scan</div>
                <p id="status" class="subtle mt-2">Scan with your bank simulator app to complete payment</p>
              </div>

              <div class="text-sm-end">
                <div class="subtle mb-1">Time remaining</div>
                <div id="timer" class="timer">Time remaining: 5:00</div>
              </div>
            </div>

            <div class="qr-box">
              <img src="<%= qrCodeUrl %>" alt="NETS QR Code" class="qr-img" />
            </div>

            <div class="mini-row">
              <div class="mini">
                <div class="label">Transaction Reference</div>
                <div class="value"><%= txnRetrievalRef %></div>
              </div>
              <div class="mini">
                <div class="label">Course Init ID</div>
                <div class="value"><%= courseInitId %></div>
              </div>
            </div>

            <div class="d-grid gap-2 d-sm-flex justify-content-sm-between mt-4">
              <a href="/checkout" class="btn btn-outline-pink px-4">Back</a>
              <a href="/" class="btn btn-outline-secondary px-4">Cancel</a>
            </div>
          </div>
        </div>

        <div class="col-lg-5">
          <div class="nets-card">
            <h5 class="fw-bold mb-2" style="color:#312631;">How to pay</h5>
            <p class="subtle mb-3">Open your banking app, scan the QR code, and confirm the payment.</p>

            <div class="text-center">
              <img src="/images/netsQrInfo.png" alt="NETS QR Info" class="info-img" />
            </div>

            <p class="subtle mt-3 mb-0">
              Tip: If the timer ends before you confirm, you can go back and try again.
            </p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <%- include('partials/footer') %>

  <script>
    let s2sNetsTxnStatus;

    if (s2sNetsTxnStatus) {
      s2sNetsTxnStatus.close();
    }

    const txnRetrievalRef = "<%= txnRetrievalRef %>";
    const courseInitId = "<%= courseInitId %>";
    const url = `/sse/payment-status/${txnRetrievalRef}`;

    const headers = {
      "api-key": "<%= apiKey %>",
      "project-id": "<%= projectId %>",
    };

    console.log("NETS REQUEST response:", <%- JSON.stringify(fullNetsResponse) %>);

    // UI helpers
    const statusTextEl = document.getElementById("status");
    const statusPillEl = document.getElementById("status-pill");

    function setStatus(text, state) {
      statusTextEl.textContent = text;

      // state: "waiting" | "ok" | "fail"
      if (state === "ok") {
        statusPillEl.classList.add("ok");
        statusPillEl.textContent = "Payment confirmed";
      } else if (state === "fail") {
        statusPillEl.classList.remove("ok");
        statusPillEl.textContent = "Payment failed";
      } else {
        statusPillEl.classList.remove("ok");
        statusPillEl.textContent = "Waiting for scan";
      }
    }

    // Initialize EventSourcePolyfill
    s2sNetsTxnStatus = new EventSourcePolyfill(url, {
      headers: headers,
      heartbeatTimeout: 150000,
    });

    setStatus("Scan with your bank simulator app to complete payment", "waiting");

    s2sNetsTxnStatus.addEventListener("message", (event) => {
      const data = JSON.parse(event.data);
      console.log("NETS Query Response:", data);

      if (data.success) {
        setStatus("Payment successful! Redirecting…", "ok");
        if (s2sNetsTxnStatus) s2sNetsTxnStatus.close();
        window.location.href = `/nets-qr/success?txn_retrieval_ref=${txnRetrievalRef}`;
      } else if (data.fail) {
        setStatus("Payment failed or timed out. Redirecting…", "fail");
        if (s2sNetsTxnStatus) s2sNetsTxnStatus.close();
        window.location.href = `/nets-qr/fail?txn_retrieval_ref=${txnRetrievalRef}`;
      }
    });

    console.log("Initialized EventSourcePolyfill");

    
    // Countdown Timer Logic
    const timerElement = document.getElementById("timer");
    const countdownDuration = 300; // 5 minutes in seconds
    let remainingTime = countdownDuration;

    const updateTimer = () => {
      const minutes = Math.floor(remainingTime / 60);
      const seconds = remainingTime % 60;

      timerElement.textContent =
        `Time remaining: ${minutes}:${seconds.toString().padStart(2, "0")}`;

      remainingTime--;

      if (remainingTime < 0) {
        clearInterval(timerInterval);
        setStatus("Transaction timed out. Redirecting…", "fail");

        if (s2sNetsTxnStatus) {
          s2sNetsTxnStatus.close();
        }
        window.location.href = `/nets-qr/fail?txn_retrieval_ref=${txnRetrievalRef}`;
      }
    };

    const timerInterval = setInterval(updateTimer, 1000);
    updateTimer();
  </script>
</body>
</html>
